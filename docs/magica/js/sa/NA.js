/*! todestrieb: Magical Girls Gallery Â© 2021 LiviaMedeiros */
'use strict';((S,I)=>{var v=null,J={},k={fix_scrollbug:!1,fix_titlebug:!1,keep_statbug:!1,keep_exbug:!1,limit_height:!1,hide_missing:!1,show_kana:!1,text_case:!1,font:"koruri",no_file:!1,all_discs:!1,mirror:!1},T=null,K=null;const w=new Map,L=new Map,B=new Map,C=new Map,U=["lm_click","lm_touch"],M=(a,b=189)=>{a=a.replace(/[^A-Za-z0-9\+\/]/g,"");for(var c=a.length,d=Math.ceil(3*c+1>>2),g=new Uint8Array(d),h,p=0,l=0,q=0;q<c;q++){h=q&3;let m=a.charCodeAt(q);p|=(64<m&&91>m?m-65:96<m&&123>m?m-71:47<m&&
58>m?m+4:43===m?62:47===m?63:0)<<6*(3-h);if(3===h||1===c-q){for(h=0;3>h&&l<d;h++,l++)g[l]=p>>>(16>>>h&24)&255^b;p=0}}return g},t=document.getElementById.bind(document);document.querySelectorAll.bind(document);const e=(a="div",b={},c=[])=>{const {d={},c:g=[],g:h={}}=b;(a=Object.assign(document.createElement(a),h)).append(...c);Object.assign(a.dataset,d);a.classList.add(...g);return a},N=a=>fetch(new URL("magica/json/"+a+".json",location.origin),{cache:"force-cache"}).then(b=>location.hostname.toLowerCase().startsWith(S)&&
b.json()),V=a=>Object.entries(a).forEach(([b,c])=>C.set(b,new URL(URL.createObjectURL(new Blob([M(c,0)],{type:"image/png"}))))),ha=(a,b=!1)=>{a||(k.no_file=!0,a='{"data":{}}');try{J=Object.freeze(JSON.parse(a))}catch(c){return O(c)}if(b)try{b=JSON.parse(b)}catch{}Object.assign(k,("object"===typeof b?b:{})||{},J.adjustments||{});return J},D=a=>document.documentElement.classList.toggle("connecting",a),ia=a=>{a=(new TextDecoder).decode(M(a));try{v=Object.freeze(JSON.parse(a))}catch(b){O(b)}v.chara.forEach(({id:b})=>
w.set(b,v.card.filter(c=>c.charaNo===b)))},P=(a,b=[],c=2,d=100)=>{a.font&&b.push("@font-face{font-family:'Open Sans';src:url("+URL.createObjectURL(new Blob([M(a.font)],{type:"font/ttf"}))+");}");a.raw&&b.push(...a.raw);a.href&&document.head.append(e("link",{g:{rel:"stylesheet",type:"text/css",href:a.href}}));(new Promise(g=>{const h=setInterval(()=>{var p=document.styleSheets[c];return p&&(clearInterval(h),g(p))},d)})).then(g=>b.forEach(h=>g.insertRule(h,g.cssRules.length)))},W=(a=document.documentElement.classList)=>
{a.remove(...U);a.add([U[+/ios|android/i.test(navigator.userAgent)]])},ja=a=>(a=a.originalEvent?.state)&&a.chara&&a.card?X(a):(t("mainContent").classList.remove("hide"),t("cardDetail").classList.add("hide"),Y("status")),x=a=>{document.documentElement.classList.add("lm_warn");Object.assign(t("loading")??{},{title:"An error occured. You can try to reload the page.",onpointerup:()=>location.reload()});return console.warn(a),!1},O=a=>{document.documentElement.classList.add("lm_error");$("#loading").attr({title:"An error occured. You can report about it."}).find("p").on("pointerup",
()=>location.assign(new URL(I+"/"+S+"/issues","https://github.com")));return console.error(a.originalEvent),!1},Z=a=>{a.forEach((b,c)=>B.set(c,b));B.forEach((b,c)=>(b=C.get(b))?($("img[data-nativeimgkey="+c+"]").removeAttr("data-nativeimgkey data-src").attr({src:b}),$(".lm_ob[data-nativebgkey="+c+"]").removeClass(["lm_ob"]).removeAttr("data-nativebgkey data-src").css({backgroundImage:"url("+b+")"})):x(c))},E=(a=new Map)=>{$("img").filter("[data-nativeimgkey]").each((b,{dataset:c})=>(b=c.nativeimgkey)&&
!B.has(b)?a.set(b,c.src):!0);$(".lm_ob").filter("[data-nativebgkey]").each((b,{dataset:c})=>(b=c.nativebgkey)&&!B.has(b)?a.set(b,c.src):!0);if([...a.values()].every(C.has.bind(C)))return Z(a);D(!0);Promise.all([...(new Set([...a.keys()].filter(b=>/^card_\d{5}_c$/.test(b))))].map(b=>N("card_c_"+b.substr(5,4)))).then(b=>{b.forEach(V);Z(a);D(!1)}).catch(x)},aa=(a,b)=>k.card_probability?Math.random()<k.card_probability:L.get(a)?.has(b),ka=({attributeId:a,name:b,id:c,title:d,kana:g})=>e("div",{c:["lm_missing",
"chara","commonFrame4","se_decide",a],g:{title:b},d:{charaId:c,maxCardRank:0}},[e("div",{c:["nameWrap"]},[e("span",{c:["att",a]}),e("p",{c:["name"],g:{textContent:b}},[e("span",{c:["title"],g:{textContent:d}})]),e("p",{c:["kana"],g:{textContent:g}})]),e("div",{c:["charaIconWrap"]})]),y=(a,b,c="id")=>v[a].find(({[c]:d})=>d===b),Q=(a,b)=>({alt:"","data-nativeimgkey":a,"data-src":"resource/image_native/"+b+"/"+a+".png"}),u=(a,b)=>({nativeimgkey:a,src:"resource/image_native/"+b+"/"+a+".png"}),ba=(a,b)=>
({["nat"+I.substr(1,2)+"ebgkey"]:a,src:"resource/image_native/"+b+"/"+a+".png"}),ma=a=>{const b=a.id,c=k.chara_probability?Math.random()<k.chara_probability:L.get(b)?.size;if(k.hide_missing&&!c)return!1;const d=ka(a);w.get(b).forEach(g=>{const {id:h,rank:p}=g,l=e("div",{c:["userCharaIcon",g.attributeId,p]});if(aa(g.charaNo,h)){const q=+p.split("RANK_")[1];q>+d.dataset.maxCardRank&&(Object.assign(d.dataset,{maxCardId:h,maxCardRank:q}),d.classList.remove("lm_missing"));Object.assign(d,{tabIndex:"2"});
l.append(...ca(g))}else l.append(e("span",{c:["closed"]}));d.querySelector(".charaIconWrap").append(l)});c&&d.addEventListener("pointerup",la);t("charaWrapInner").append(d)},ca=a=>[["att","att","attributeId"],["star","star","rank"],["rank","frame","rank"],[!1,"card","id","_f"],["bg","bg","attributeId"]].map(([b,c,d,g=""])=>(d=c+"_"+String(a[d]).toLowerCase()+g,b?e("span",{c:["lm_ob",b],d:ba(d,"card/frame")}):e("img",{g:{alt:""},d:u(d,"card/image")}))),la=a=>{if(!a.cancelable&&a.isTrusted&&k.fix_scrollbug)return!0;
a.preventDefault();const {charaId:b,maxCardId:c}=a.currentTarget.dataset;a={page:"mgirl",chara:+b,card:+c};history.pushState(a,"Magical Girl \u2116"+b);return X(a)},X=({chara:a,card:b})=>{if(!na(y("chara",a),y("card",b)))return!1;E();t("mainContent").classList.add("hide");t("cardDetail").classList.remove("hide")},da=a=>e("div",{c:["detailWrap"]},[e("p",{c:["name","c_purple"],g:{innerText:a.name}}),e("div",{c:["common_line","lc_beige"]}),e("p",{c:["detail"],g:{innerText:a.shortDescription}})]),na=
(a,b)=>{if(!b)return!1;const c=T.clone(),{id:d,attributeId:g,title:h}=a,{id:p,rank:l,maxPieceSkillId:[q],doppelMagiaId:m,commandType:ea}=b;(f=>{$("#att",f).addClass([g.toLowerCase()]);$(".charaName",f).text(a.name).append(h&&e("span",{c:["title","ts_pink"],g:{innerText:h}}))})($("#detailCardName",c));var z=u("card_"+p+"_c","card/image");$("#detailCardImage",c).append(e("div",{c:["lm_ob","cardFrame",l,g],d:ba("frame_"+g.toLowerCase()+"_"+l.toLowerCase(),"card/frame")}),e("img",{c:["cardImg","se_tabs"],
g:{title:"Tap to zoom in"},d:z}),e("img",{c:["zoomImg","se_tabs"],g:{title:"Tap to zoom out"},d:z}),e("span",{c:["moviePlayBtn","se_tabs","TE"],g:{title:"Transformation videos are disabled in this version"}}));const fa=+l.split("RANK_")[1],[F,G,R]=["Status","Skill","Illust"].map(f=>$("#chara"+f,c));(f=>{$("img",f).attr(Q("mini_"+b.miniCharaNo+"_s","mini/image"));$("#rare",f).removeClass().addClass([l]).append(Array(fa).fill("<span>").map(n=>$(n)))})($("#cardDetailMiniChara",F));(f=>{$(".currentLv,.maxLv",
$("#detailLv",f)).text([1,40,50,60,80,100][+l.split("RANK_")[1]]||1);$(".type>.tdStyle",f).text({BALANCE:"Balanced",ATTACK:"Attack",DEFENSE:"Defense",MAGIA:"Magia",HEAL:"Heal",SUPPORT:"Support",ULTIMATE:"Ultimate",CIRCLE_MAGIA:"Cycle Magia"}[b.initialType])})($(".statusWrap",F));(f=>({BALANCE:[1,1,1],ATTACK:[.98,1.03,.97],DEFENSE:[.97,.98,1.05],HP:[1.04,.97,.98],ATKDEF:[.99,1.02,1.01],ATKHP:[1.02,1.01,.99],DEFHP:[1.01,.99,1.02]})[b.growthType].map((n,r)=>f.eq(r).text(+b[["hp","attack","defense"][r]]*
(1+(k.keep_statbug?3:[0,2,2.2,2.4,2.6,3][+l.split("RANK_")[1]]||1)*n)|0)))($("#popupCharaStatus .c_red",F));[[".profileWrap>.detail",a.description],[".exProfile1>.tdStyle",a.school],[".selCharacterDesign",a.designer],[".selIllustTitle","\u2605"+fa+" Illustrator"],[".selIllustrator",b.illustrator],[".selCharacterVoice",a.voiceActor]].forEach(([f,n])=>F[0].querySelector(f).innerText=n);[["skill",".connect"],["magia",".magiaDetail"]].map(([f,n])=>{n=G[0].querySelector(n);const {groupId:r,name:H,shortDescription:A}=
y(f,b[f+"Id"]);Object.assign(n.querySelector("img").dataset,u("icon_skill_"+r,"art"));n.querySelector(".name").innerText=H;n.querySelector(".detail").innerText=A});G[0].querySelector(".commandList").append(...ea.map(f=>e("li",{c:[k.all_discs||f]})));R[0].querySelector(".discPreview").append(...ea.map(f=>e("div",{c:["discWrap",f]},[e("div",{c:["discText"]}),e("img",{d:u("card_"+p+"_d","card/image")})])));q&&(z=y("pieceskill",q),$(".command",G).after($("<div>",{"class":"commonFrame3 connect",append:[$("<p>",
{"class":"common_title_frame",text:"EX Skill"}),$("<div>",{"class":k.keep_exbug?"flexbox":"flexBox",append:[$("<p>",{"class":"img",append:e("img",{d:u("icon_skill_"+z.groupId,"art")})}),$(da(z))]})]})));m&&$(".magia",G).append($("<div>",{"class":"doppel doppelDetail",append:$("<div>",{"class":"flexBox",append:[$("<p>",{"class":"img doppel",append:[e("img",{d:u("mini_"+b.doppelCharaNo+"_dd","mini/image")}),e("span",{c:["bg"]})]}),$(da(y("magia",m)))]})}));w.get(d).forEach((f,n)=>{var r=f.id;const H=
"mb_pink se_decide"+(r===p?" selected":""),A="\u2605"+ +f.rank.split("RANK_")[1];r=aa(d,r);$(".miniCharaBtn",R).append($("<p>",r?{"class":H,tabindex:"4",data:{commandtype:"card",cardarrindex:n}}:{"class":"mb_pink off"}).text(A));$(".selIllustIcon",R).append($("<div>",{"class":"cardIllustWrap"}).append($("<div>",r?{"class":"userCharaIcon "+f.attributeId,append:ca(f)}:{"class":"offIcon"}),$("<p>",r?{"class":H,text:A,tabindex:"5",data:{cardarrindex:n}}:{"class":"mb_pink off",text:A})))});$("#cardDetail").data({charaId:d}).off().on("pointerup",
".collectionBack",()=>history.back()).on("pointerup","#detailCardImage>img",()=>t("detailCardImage").classList.toggle("zoom")).on("pointerup","#detailTab>li",Y).on("pointerup",".moviePlayBtn",()=>setTimeout(f=>f.removeClass(),1500,$("#ready").addClass(["preNativeFadeIn"]))).on("pointerup",".cardIllustWrap>.mb_pink",oa).on("pointerup",".miniCharaBtn>.mb_pink",pa).empty().append(c);return!0},Y=a=>{a=a.currentTarget?$(a.currentTarget).attr("data-type"):a;$("#cardDetailWrap").removeClass().addClass([a]);
$("#detailTab>li").removeClass(["current"]).filter("[data-type="+a+"]").addClass(["current"])},oa=a=>{a.preventDefault();$(".cardIllustWrap>.selected").removeClass(["selected"]);const {id:b,rank:c,attributeId:d,illustrator:g}=w.get($("#cardDetail").data("charaId"))[$(a.currentTarget).addClass(["selected"]).data("cardarrindex")];a=$("#detailCardImage");$("img",a).attr(Q("card_"+b+"_c","card/image"));a=$(".cardFrame",a).addClass(["lm_ob"]);var h="frame_"+d.toLowerCase()+"_"+c.toLowerCase();a.attr.call(a,
{["data-nat"+I.substr(1,2)+"ebgkey"]:h,"data-src":"resource/image_native/card/frame/"+h+".png"});$(".illustrator").text(g);$(".selIllustTitle").text("\u2605"+ +c.split("RANK_")[1]+" Illustrator:");E()},pa=a=>{a.preventDefault();a=$(a.currentTarget);if(!a.is(".off,.selected")){$(".miniCharaBtn>.selected").removeClass("selected");a=a.addClass(["selected"]).data();var b=w.get($("#cardDetail").data("charaId"))[a.cardarrindex||0];$(".discPreview>.discWrap>img").attr(Q(...("chara"===a.commandtype?["mini_"+
b.miniCharaNo+"_d","mini/image"]:["card_"+b.id+"_d","card/image"])));E()}},qa=a=>{a.preventDefault();$(".tabBtns>.current").removeClass(["current"]);$("#charaWrap").removeClass().addClass([$(a.currentTarget).addClass(["current"]).data("att").toLowerCase(),"commonFrame2"])};$(document).on("pointerdown",".TE",({currentTarget:a})=>$(a).not(".off,.current,.selected").addClass(["touch"])).on("pointermove pointerup",".TE",({currentTarget:a})=>a.classList.remove("touch")).on("pointerdown","body",a=>setTimeout(b=>
b.remove(),700,(b=>$("<div>",{"class":"commonEffect",css:{top:b.clientY-128+"px",left:b.clientX-128+"px"},append:Array.from({length:3},(c,d)=>e("div",{c:["effect0"+(d+1)]}))}).appendTo("body"))(a))).on("keydown","[tabindex]",a=>("Enter"===a.key&&$(a.currentTarget).trigger("pointerup"),!0)).on("contextmenu",a=>(a.preventDefault(),document.documentElement.requestFullscreen().catch(x))).one("DOMContentLoaded",()=>{D(!0);W();$(window).on({resize:()=>K=K?clearTimeout(K):setTimeout(W,500),popstate:ja,"error unhandledrejection":O});
history.replaceState({page:"mgirls"},"Magical Girls Gallery");const a=ha(...["gallery","adjustments"].map(b=>document.cookie.match(new RegExp("(?:^|;)\\s*"+b+"\\s*=\\s*([^;]*)"))?.pop()||null));k.mirror&&document.documentElement.classList.add("lm_rorrim");k.limit_height&&document.documentElement.classList.add("lm_limit_height");k.fix_titlebug&&P({raw:["{margin-left:8px;}",'::before{content:"[";}','::after{content:"]";}'].map(b=>"#detailCardName>.charaName>.title"+b)});k.no_file&&document.body.append(e("a",
{g:{id:"lm_use_setup",href:new URL("setup",location.origin)}}));k.text_case&&document.documentElement.classList.add("lm_to"+k.text_case);k.show_kana&&document.documentElement.classList.add("lm_kana");k.font?N("font/"+k.font).then(P).catch(x):P({href:new URL("css?family=Open+Sans:600","https://fonts.googleapis.com")});Promise.all("art card_d card_f frame mini_d mini_dd mini_s mirrors".split(" ").map(N)).then(b=>{ia(b.pop().data);b.forEach(V);Object.entries(a.data).forEach(([c,d])=>L.set(+c,new Set(d.map(Number))));
b=t("charaWrapInner");b.style.display="none";T=$($("#tmplCharaDetail").detach()[0].content);v.chara.forEach(ma);E();D(!1);b.style.display="block";$("#tabArea>.tabBtns>li").on("pointerup",qa)}).catch(x)})})
("todestrieb", "LiviaMedeiros");
