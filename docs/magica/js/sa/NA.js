/*! todestrieb: Magical Girls Gallery Â© 2021 LiviaMedeiros */
'use strict';((ca,da)=>{var F=null,S={},k={fix_scrollbug:!1,fix_titlebug:!1,keep_statbug:!1,keep_exbug:!1,limit_width:!1,limit_height:!1,hide_missing:!1,show_kana:!1,text_case:!1,font:"koruri",no_file:!1,all_discs:!1,mirror:!1},ea=null,T=null,ua=0,U=1;const z=document.documentElement,[G,M,N,O,V]=Array.from({length:5},()=>new Map),fa=new Worker(new URL("familiar.mjs",location.origin));fa.addEventListener("message",({data:a})=>{const b=V.get(a.h);V.delete(a.h);return a.reject?b.reject(a.reject):b.resolve(a.resolve)});
const W=(...a)=>{const b=ua++,c=new Promise((d,f)=>V.set(b,{resolve:d,reject:f}));fa.postMessage({$:a,h:b});return c},ha=a=>Promise.all(Object.entries(a).map(([b,c])=>W(c,0).then(d=>O.set(b,new URL(URL.createObjectURL(new Blob([d],{type:"image/png"}))))))),va=a=>W(a).then(b=>{b=(new TextDecoder).decode(b);try{F=Object.freeze(JSON.parse(b))}catch(c){X(c)}F.chara.forEach(({id:c})=>G.set(c,F.card.filter(d=>d.charaNo===c)))}),x=(a,b)=>{a.innerText=b;return a},l=(a,...b)=>{a.classList.add(...b);return a},
t=(a,...b)=>{a.classList.remove(...(b.length?b:a.classList));return a},Y=(a,b)=>b.some(c=>a.classList.contains(c)),n=document.getElementById.bind(document),A=(a,b={})=>{Object.assign(a.dataset,b);return a},H=(a,b={})=>Object.assign(a,b),P=(a,b)=>{Object.assign(a.style,b);return a},ia=({dataset:a})=>["nativeimgkey","nativebgkey","src"].forEach(b=>delete a[b]),v=(a,b,c=document)=>c.querySelectorAll(a).forEach(b),g=(a,b=document)=>b.querySelector(a),e=(a="div",{d:b={},c=[],g:d={},a:f=[],i:m={}}={},p=
[])=>{(a=H(document.createElement(a),d)).append(...f,...p);return l(A(P(a,m),b),...c)},B=(a,b,c,d=!1,...f)=>{b.forEach(m=>a.addEventListener(m,d?(p,...u)=>{for(let w=p.target;w&&w!=p.currentTarget;w=w.parentNode)if(w.matches(d))return c(p,...u)}:c,...f));return a},Z=a=>fetch(new URL("magica/json/"+a+".json",location.origin),{cache:"force-cache"}).then(b=>location.hostname.toLowerCase().startsWith(ca)&&b.json()),wa=(a,b=!1)=>{a||(k.no_file=!0,a='{"data":{}}');try{S=Object.freeze(JSON.parse(a))}catch(c){return X(c)}if(b)try{b=
JSON.parse(b)}catch{}Object.assign(k,("object"===typeof b?b:{})||{},S.adjustments||{});return S},Q=a=>z.classList.toggle("connecting",a),aa=(a,b=[],c=2,d=100)=>{a.font&&W(a.font).then(f=>b.push("@font-face{font-family:'Open Sans';src:url("+URL.createObjectURL(new Blob([f],{type:"font/ttf"}))+");}"));a.raw&&b.push(...a.raw);a.href&&document.head.append(e("link",{g:{rel:"stylesheet",type:"text/css",href:a.href}}));(new Promise(f=>{const m=setInterval(()=>{var p=document.styleSheets[c];return p&&(clearInterval(m),
f(p))},d)})).then(f=>b.forEach(m=>f.insertRule(m,f.cssRules.length)))},ja=()=>{var a=["lm_click","lm_touch"];return l(t(z,...a),a[+/ios|android/i.test(navigator.userAgent)])},ka=()=>U=k.limit_width?1:document.documentElement.style.zoom=window.innerWidth/1024,xa=a=>(a=a.state)&&a.chara&&a.card?la(a):(t(n("mainContent"),"hide"),l(n("cardDetail"),"hide"),ma("status")),C=(...a)=>{console.warn(...a);l(z,"lm_warn");B(H(n("loading"),{title:"An error occured. You can try to reload the page."}),["pointerup"],
()=>location.reload());return!1},X=(...a)=>{console.error(...a);l(z,"lm_error");B(H(g("p",H(n("loading"),{title:"An error occured. You can report about it."}))),["pointerup"],()=>location.assign(new URL(da+"/"+ca+"/issues","https://github.com")));return!1},na=a=>{a.forEach((b,c)=>N.set(c,b));N.forEach((b,c)=>{const d=O.get(b);if(!d)return C("unknown key",c);v("img[data-nativeimgkey="+c+"]",f=>ia(H(f,{src:d})));v(".lm_ob[data-nativebgkey="+c+"]",f=>ia(t(P(f,{backgroundImage:"url("+d+")"}),"lm_ob")))});
return!1},R=async()=>{const a=new Map;v("img[data-nativeimgkey]",({dataset:{nativeimgkey:b,src:c}})=>b&&!N.has(b)&&a.set(b,c));v(".lm_ob[data-nativebgkey]",({dataset:{nativebgkey:b,src:c}})=>b&&!N.has(b)&&a.set(b,c));if([...a.values()].every(O.has.bind(O)))return na(a);Q(!0);return Promise.all([...(new Set([...a.keys()].filter(b=>/^card_\d{5}_c$/.test(b))))].map(b=>Z("card_c_"+b.substr(5,4)))).then(b=>Promise.all(b.map(ha))).then(()=>na(a)).then(Q).catch(C)},oa=(a,b)=>k.card_probability?Math.random()<
k.card_probability:M.get(a)?.has(b),ya=({attributeId:a,name:b,id:c,title:d,kana:f})=>e("div",{c:["lm_missing","chara","commonFrame4","se_decide",a],g:{title:b},d:{charaId:c,maxCardRank:0}},[e("div",{c:["nameWrap"]},[e("span",{c:["att",a]}),e("p",{c:["name"],g:{textContent:b}},[e("span",{c:["title"],g:{textContent:d}})]),e("p",{c:["kana"],g:{textContent:f}})]),e("div",{c:["charaIconWrap"]})]),I=(a,b,c="id")=>F[a].find(({[c]:d})=>d===b),y=(a,b)=>({nativeimgkey:a,src:"resource/image_native/"+b+"/"+a+
".png"}),ba=(a,b)=>({["nat"+da.substr(1,2)+"ebgkey"]:a,src:"resource/image_native/"+b+"/"+a+".png"}),Aa=async a=>{const b=a.id,c=k.chara_probability?Math.random()<k.chara_probability:M.get(b)?.size;return k.hide_missing&&!c?!1:(d=>{G.get(b).forEach(f=>{const {id:m,rank:p}=f,u=e("div",{c:["userCharaIcon",f.attributeId,p]});if(oa(f.charaNo,m)){const w=+p.split("RANK_")[1];w>+Object.assign(d,{tabIndex:"2"}).dataset.maxCardRank&&A(t(d,"lm_missing"),{maxCardId:m,maxCardRank:w});u.append(...pa(f))}else u.append(e("span",
{c:["closed"]}));g(".charaIconWrap",d).append(u)});n("charaWrapInner").append(c?B(d,["pointerup"],za):d)})(ya(a))},pa=a=>[["att","att","attributeId"],["star","star","rank"],["rank","frame","rank"],[!1,"card","id","_f"],["bg","bg","attributeId"]].map(([b,c,d,f=""])=>(d=c+"_"+String(a[d]).toLowerCase()+f,b?e("span",{c:["lm_ob",b],d:ba(d,"card/frame")}):e("img",{g:{alt:""},d:y(d,"card/image")}))),za=a=>{if(!a.cancelable&&a.isTrusted&&k.fix_scrollbug)return!0;const {charaId:b,maxCardId:c}=a.currentTarget.dataset;
a={page:"mgirl",chara:+b,card:+c};history.pushState(a,"Magical Girl \u2116"+b);return la(a)},la=({chara:a,card:b})=>{Ba(I("chara",a),I("card",b)).then(c=>!1!==c&&R()).then(()=>{l(n("mainContent"),"hide");t(n("cardDetail"),"hide")}).catch(C)},qa=a=>e("div",{c:["detailWrap"]},[e("p",{c:["name","c_purple"],g:{innerText:a.name}}),e("div",{c:["common_line","lc_beige"]}),e("p",{c:["detail"],g:{innerText:a.shortDescription}})]),Ea=(a,b,c)=>{const {id:d,attributeId:f,title:m}=a,{id:p,rank:u,maxPieceSkillId:[w],
doppelMagiaId:ra,commandType:sa}=b;(r=>{l(g("#att",r),f.toLowerCase());x(g(".charaName",r),a.name).append(...(m?[e("span",{c:["title","ts_pink"],g:{innerText:m}})]:[]))})(g("#detailCardName",c));(r=>g("#detailCardImage",c).append(e("div",{c:["lm_ob","cardFrame",u,f],d:ba("frame_"+f.toLowerCase()+"_"+u.toLowerCase(),"card/frame")}),e("img",{c:["cardImg","se_tabs"],g:{alt:"",title:"Tap to zoom in"},d:r}),e("img",{c:["zoomImg","se_tabs"],g:{alt:"",title:"Tap to zoom out"},d:r}),e("span",{c:["moviePlayBtn",
"se_tabs","TE"],g:{title:"Transformation videos are disabled in this version"}})))(y("card_"+p+"_c","card/image"));(([r,E,J],ta)=>{(h=>{A(g("img",h),y("mini_"+b.miniCharaNo+"_s","mini/image"));l(g("#rare",h),u).append(...Array(ta).fill("span").map(q=>e(q)))})(g("#cardDetailMiniChara",r));(h=>{v(".currentLv,.maxLv",q=>x(q,[1,40,50,60,80,100][+u.split("RANK_")[1]]||1),g("#detailLv",h));x(g(".type>.tdStyle",h),{BALANCE:"Balanced",ATTACK:"Attack",DEFENSE:"Defense",MAGIA:"Magia",HEAL:"Heal",SUPPORT:"Support",
ULTIMATE:"Ultimate",CIRCLE_MAGIA:"Cycle Magia"}[b.initialType])})(g(".statusWrap",r));v("#popupCharaStatus .c_red",(h,q)=>x(h,+b[["hp","attack","defense"][q]]*(1+(k.keep_statbug?3:[0,2,2.2,2.4,2.6,3][+u.split("RANK_")[1]]||1)*{BALANCE:[1,1,1],ATTACK:[.98,1.03,.97],DEFENSE:[.97,.98,1.05],HP:[1.04,.97,.98],ATKDEF:[.99,1.02,1.01],ATKHP:[1.02,1.01,.99],DEFHP:[1.01,.99,1.02]}[b.growthType][q])|0),r);[[".profileWrap>.detail",a.description],[".exProfile1>.tdStyle",a.school],[".selCharacterDesign",a.designer],
[".selIllustTitle","\u2605"+ta+" Illustrator"],[".selIllustrator",b.illustrator],[".selCharacterVoice",a.voiceActor]].forEach(([h,q])=>x(g(h,r),q));[["skill",".connect"],["magia",".magiaDetail"]].map(([h,q])=>{q=g(q,E);const {groupId:D,name:K,shortDescription:L}=I(h,b[h+"Id"]);A(g("img",q),y("icon_skill_"+D,"art"));x(g(".name",q),K);x(g(".detail",q),L)});g(".commandList",E).append(...sa.map(h=>e("li",{c:[k.all_discs||h]})));if(w){const h=I("pieceskill",w);g(".command",E).after(e("div",{c:["commonFrame3",
"connect"]},[e("p",{c:["common_title_frame"],g:{innerText:"EX Skill"}}),e("div",{c:[k.keep_exbug?"flexbox":"flexBox"]},[e("p",{c:["img"]},[e("img",{d:y("icon_skill_"+h.groupId,"art")})]),qa(h)])]))}ra&&g(".magia",E).append(e("div",{c:["doppel","doppelDetail"]},[e("div",{c:["flexBox"]},[e("p",{c:["img","doppel"]},[e("img",{d:y("mini_"+b.doppelCharaNo+"_dd","mini/image")}),e("span",{c:["bg"]})]),qa(I("magia",ra))])]));g(".discPreview",J).append(...sa.map(h=>e("div",{c:["discWrap",h]},[e("div",{c:["discText"]}),
e("img",{d:y("card_"+p+"_d","card/image")})])));G.get(d).forEach((h,q)=>{var D=h.id;const K="\u2605"+ +h.rank.split("RANK_")[1],L=["mb_pink","se_decide"];D===p&&L.push("selected");D=oa(d,D);g(".miniCharaBtn",J).append(x(e("p",D?{c:L,g:{tabIndex:"4"},d:{commandtype:"card",cardarrindex:q}}:{c:["mb_pink","off"]}),K));g(".selIllustIcon",J).append(e("div",{c:["cardIllustWrap"]},[e("div",D?{c:["userCharaIcon",h.attributeId],a:pa(h)}:{c:["offIcon"]}),e("p",D?{c:L,g:{innerText:K,tabIndex:"5"},d:{cardarrindex:q}}:
{c:["mb_pink","off"],g:{innerText:K}})]))})})(["Status","Skill","Illust"].map(r=>g("#chara"+r,c)),+u.split("RANK_")[1]);[[".collectionBack",()=>history.back()],["#detailCardImage>img",()=>n("detailCardImage").classList.toggle("zoom")],["#detailTab>li",ma],[".moviePlayBtn",()=>setTimeout(r=>t(r),1500,l(n("ready"),"preNativeFadeIn"))],[".cardIllustWrap>.mb_pink",Ca],[".miniCharaBtn>.mb_pink",Da]].forEach(([r,E])=>v(r,J=>B(J,["pointerup"],E),c));return c},Ba=async(a,b)=>{var c;if(c=b)c=A(n("cardDetail"),
{charaId:a.id}),a=[Ea(a,b,ea.cloneNode(!0))],c.replaceChildren(...a);return c},ma=a=>{const b=a.currentTarget?.dataset.type??a;l(t(n("cardDetailWrap")),b);v("#detailTab>li",c=>(c.dataset.type===b?l:t)(c,"current"))},Ca=({currentTarget:a})=>{if(!Y(a,["off","selected"])){t(g(".cardIllustWrap>.selected"),"selected");var {id:b,rank:c,attributeId:d,illustrator:f}=G.get(+n("cardDetail").dataset.charaId)[+l(a,"selected").dataset.cardarrindex];(m=>{v("img",p=>A(p,y("card_"+b+"_c","card/image")),m);A(l(g(".cardFrame",
m),"lm_ob"),ba("frame_"+d.toLowerCase()+"_"+c.toLowerCase(),"card/frame"))})(n("detailCardImage"));x(g(".illustrator"),f);x(g(".selIllustTitle"),"\u2605"+ +c.split("RANK_")[1]+" Illustrator:");R().catch(C)}},Da=({currentTarget:a})=>{if(!Y(a,["off","selected"])){t(g(".miniCharaBtn>.selected"),"selected");a=l(a,"selected").dataset;var b=G.get(+n("cardDetail").dataset.charaId)[+(a.cardarrindex||0)],c=y(...("chara"===a.commandtype?["mini_"+b.miniCharaNo+"_d","mini/image"]:["card_"+b.id+"_d","card/image"]));
v(".discPreview>.discWrap>img",d=>A(d,c));R().catch(C)}},Fa=({currentTarget:a})=>{t(g(".tabBtns>.current"),"current");l(t(n("charaWrap")),l(a,"current").dataset.att.toLowerCase(),"commonFrame2")},Ga=({target:a})=>t(a,"touch"),Ha=a=>void setTimeout(b=>b.remove(),700,(b=>document.body.appendChild(e("div",{c:["commonEffect"],i:{top:b.y/U-128+"px",left:b.x/U-128+"px"}},Array.from({length:3},(c,d)=>e("div",{c:["effect0"+(d+1)]})))))(a)),Ia=()=>{window.matchMedia("(display-mode:browser)").matches||window.resizeTo(1024+
(window.outerWidth-window.innerWidth),Math.min(window.outerHeight,768+(window.outerHeight-window.innerHeight)));k.limit_width||ka();k.mirror&&l(z,"lm_rorrim");k.limit_height&&l(z,"lm_limit_height");k.fix_titlebug&&aa({raw:["{margin-left:8px;}",'::before{content:"[";}','::after{content:"]";}'].map(a=>"#detailCardName>.charaName>.title"+a)});k.no_file&&document.body.append(e("a",{g:{id:"lm_use_setup",href:new URL("setup",location.origin)}}));k.text_case&&l(z,"lm_to"+k.text_case);k.show_kana&&l(z,"lm_kana");
k.font?Z("font/"+k.font).then(aa).catch(C):aa({href:new URL("css?family=Open+Sans:600","https://fonts.googleapis.com")})};return B(document,["DOMContentLoaded"],()=>{Q(!0);[[["resize"],()=>(ka(),T=T?clearTimeout(T):setTimeout(ja,500))],[["popstate"],xa],[["error"],X]].forEach(c=>B(window,...c));navigator.serviceWorker.register(new URL("doppel.mjs",location.origin),{type:"module"}).catch(C);ja();[[["pointerdown"],".TE",({target:c})=>Y(c,["off","current","selected"])||l(c,"touch")],[["pointerup","pointermove"],
".TE",Ga],[["pointerdown"],"body",Ha],[["keydown"],"[tabIndex]",c=>void("Enter"===c.key&&c.target.dispatchEvent(new PointerEvent("pointerup")))],[["contextmenu"],!1,c=>(c.preventDefault(),navigator.vibrate([155,167,146,62,325]),setTimeout(()=>location.assign(new URL("setup",location.origin)),900)),!1]].forEach(([c,d,f,m=!0])=>B(document,c,f,d,{passive:m}));history.replaceState({page:"mgirls"},"Magical Girls Gallery");const a=wa(...["gallery","adjustments"].map(c=>document.cookie.match(new RegExp("(?:^|;)\\s*"+
c+"\\s*=\\s*([^;]*)"))?.pop()||null));Ia();const b=P(n("charaWrapInner"),{display:"none"});Promise.all("art card_d card_f frame mini_d mini_dd mini_s mirrors".split(" ").map(Z)).then(c=>Promise.all([va(c.pop().data),...c.map(ha)])).then(()=>{Object.entries(a.data).forEach(([c,d])=>M.set(+c,new Set(d.map(Number))));(c=>{ea=c.content;c.remove()})(n("tmplCharaDetail"));return Promise.all(F.chara.map(Aa))}).then(R).then(()=>{P(b,{display:"block"});v("#tabArea>.tabBtns>li",c=>B(c,["pointerup"],Fa));Q(!1);
navigator.serviceWorker?.controller?.postMessage({action:"saveMeguca",meguca:[...M.keys()]})}).catch(C)},!1,{once:!0})})
("todestrieb", "LiviaMedeiros");