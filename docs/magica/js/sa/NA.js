/*! todestrieb: Magical Girls Gallery Â© 2021 LiviaMedeiros */
'use strict';((ba,ca)=>{var F=null,S={},l={fix_scrollbug:!1,fix_titlebug:!1,keep_statbug:!1,keep_exbug:!1,limit_height:!1,hide_missing:!1,show_kana:!1,text_case:!1,font:"koruri",no_file:!1,all_discs:!1,mirror:!1},da=null,T=null,sa=0;const z=document.documentElement,[G,M,N,O,U]=Array.from({length:5},()=>new Map),ea=new Worker(new URL("familiar.mjs",location.origin));ea.addEventListener("message",({data:a})=>{const b=U.get(a.h);U.delete(a.h);return a.reject?b.reject(a.reject):b.resolve(a.resolve)});
const V=(...a)=>{const b=sa++,c=new Promise((d,f)=>U.set(b,{resolve:d,reject:f}));ea.postMessage({$:a,h:b});return c},fa=a=>Promise.all(Object.entries(a).map(([b,c])=>V(c,0).then(d=>O.set(b,new URL(URL.createObjectURL(new Blob([d],{type:"image/png"}))))))),ta=a=>V(a).then(b=>{b=(new TextDecoder).decode(b);try{F=Object.freeze(JSON.parse(b))}catch(c){W(c)}F.chara.forEach(({id:c})=>G.set(c,F.card.filter(d=>d.charaNo===c)))}),x=(a,b)=>{a.innerText=b;return a},k=(a,...b)=>{a.classList.add(...b);return a},
t=(a,...b)=>{a.classList.remove(...(b.length?b:a.classList));return a},X=(a,b)=>b.some(c=>a.classList.contains(c)),n=document.getElementById.bind(document),A=(a,b={})=>{Object.assign(a.dataset,b);return a},H=(a,b={})=>Object.assign(a,b),P=(a,b)=>{Object.assign(a.style,b);return a},ha=({dataset:a})=>["nativeimgkey","nativebgkey","src"].forEach(b=>delete a[b]),v=(a,b,c=document)=>c.querySelectorAll(a).forEach(b),g=(a,b=document)=>b.querySelector(a),e=(a="div",{d:b={},c=[],g:d={},a:f=[],i:m={}}={},p=
[])=>{(a=H(document.createElement(a),d)).append(...f,...p);return k(A(P(a,m),b),...c)},B=(a,b,c,d=!1,...f)=>{b.forEach(m=>a.addEventListener(m,d?(p,...u)=>{for(let w=p.target;w&&w!=p.currentTarget;w=w.parentNode)if(w.matches(d))return c(p,...u)}:c,...f));return a},Y=a=>fetch(new URL("magica/json/"+a+".json",location.origin),{cache:"force-cache"}).then(b=>location.hostname.toLowerCase().startsWith(ba)&&b.json()),ua=(a,b=!1)=>{a||(l.no_file=!0,a='{"data":{}}');try{S=Object.freeze(JSON.parse(a))}catch(c){return W(c)}if(b)try{b=
JSON.parse(b)}catch{}Object.assign(l,("object"===typeof b?b:{})||{},S.adjustments||{});return S},Q=a=>z.classList.toggle("connecting",a),Z=(a,b=[],c=2,d=100)=>{a.font&&V(a.font).then(f=>b.push("@font-face{font-family:'Open Sans';src:url("+URL.createObjectURL(new Blob([f],{type:"font/ttf"}))+");}"));a.raw&&b.push(...a.raw);a.href&&document.head.append(e("link",{g:{rel:"stylesheet",type:"text/css",href:a.href}}));(new Promise(f=>{const m=setInterval(()=>{var p=document.styleSheets[c];return p&&(clearInterval(m),
f(p))},d)})).then(f=>b.forEach(m=>f.insertRule(m,f.cssRules.length)))},ia=()=>{var a=["lm_click","lm_touch"];return k(t(z,...a),a[+/ios|android/i.test(navigator.userAgent)])},va=a=>(a=a.state)&&a.chara&&a.card?ja(a):(t(n("mainContent"),"hide"),k(n("cardDetail"),"hide"),ka("status")),C=(...a)=>{console.warn(...a);k(z,"lm_warn");B(H(n("loading"),{title:"An error occured. You can try to reload the page."}),["pointerup"],()=>location.reload());return!1},W=(...a)=>{console.error(...a);k(z,"lm_error");
B(H(g("p",H(n("loading"),{title:"An error occured. You can report about it."}))),["pointerup"],()=>location.assign(new URL(ca+"/"+ba+"/issues","https://github.com")));return!1},la=a=>{a.forEach((b,c)=>N.set(c,b));N.forEach((b,c)=>{const d=O.get(b);if(!d)return C("unknown key",c);v("img[data-nativeimgkey="+c+"]",f=>ha(H(f,{src:d})));v(".lm_ob[data-nativebgkey="+c+"]",f=>ha(t(P(f,{backgroundImage:"url("+d+")"}),"lm_ob")))});return!1},R=async()=>{const a=new Map;v("img[data-nativeimgkey]",({dataset:{nativeimgkey:b,
src:c}})=>b&&!N.has(b)&&a.set(b,c));v(".lm_ob[data-nativebgkey]",({dataset:{nativebgkey:b,src:c}})=>b&&!N.has(b)&&a.set(b,c));if([...a.values()].every(O.has.bind(O)))return la(a);Q(!0);return Promise.all([...(new Set([...a.keys()].filter(b=>/^card_\d{5}_c$/.test(b))))].map(b=>Y("card_c_"+b.substr(5,4)))).then(b=>Promise.all(b.map(fa))).then(()=>la(a)).then(Q).catch(C)},ma=(a,b)=>l.card_probability?Math.random()<l.card_probability:M.get(a)?.has(b),wa=({attributeId:a,name:b,id:c,title:d,kana:f})=>e("div",
{c:["lm_missing","chara","commonFrame4","se_decide",a],g:{title:b},d:{charaId:c,maxCardRank:0}},[e("div",{c:["nameWrap"]},[e("span",{c:["att",a]}),e("p",{c:["name"],g:{textContent:b}},[e("span",{c:["title"],g:{textContent:d}})]),e("p",{c:["kana"],g:{textContent:f}})]),e("div",{c:["charaIconWrap"]})]),I=(a,b,c="id")=>F[a].find(({[c]:d})=>d===b),y=(a,b)=>({nativeimgkey:a,src:"resource/image_native/"+b+"/"+a+".png"}),aa=(a,b)=>({["nat"+ca.substr(1,2)+"ebgkey"]:a,src:"resource/image_native/"+b+"/"+a+
".png"}),ya=async a=>{const b=a.id,c=l.chara_probability?Math.random()<l.chara_probability:M.get(b)?.size;return l.hide_missing&&!c?!1:(d=>{G.get(b).forEach(f=>{const {id:m,rank:p}=f,u=e("div",{c:["userCharaIcon",f.attributeId,p]});if(ma(f.charaNo,m)){const w=+p.split("RANK_")[1];w>+Object.assign(d,{tabIndex:"2"}).dataset.maxCardRank&&A(t(d,"lm_missing"),{maxCardId:m,maxCardRank:w});u.append(...na(f))}else u.append(e("span",{c:["closed"]}));g(".charaIconWrap",d).append(u)});n("charaWrapInner").append(c?
B(d,["pointerup"],xa):d)})(wa(a))},na=a=>[["att","att","attributeId"],["star","star","rank"],["rank","frame","rank"],[!1,"card","id","_f"],["bg","bg","attributeId"]].map(([b,c,d,f=""])=>(d=c+"_"+String(a[d]).toLowerCase()+f,b?e("span",{c:["lm_ob",b],d:aa(d,"card/frame")}):e("img",{g:{alt:""},d:y(d,"card/image")}))),xa=a=>{if(!a.cancelable&&a.isTrusted&&l.fix_scrollbug)return!0;const {charaId:b,maxCardId:c}=a.currentTarget.dataset;a={page:"mgirl",chara:+b,card:+c};history.pushState(a,"Magical Girl \u2116"+
b);return ja(a)},ja=({chara:a,card:b})=>{za(I("chara",a),I("card",b)).then(c=>!1!==c&&R()).then(()=>{k(n("mainContent"),"hide");t(n("cardDetail"),"hide")}).catch(C)},oa=a=>e("div",{c:["detailWrap"]},[e("p",{c:["name","c_purple"],g:{innerText:a.name}}),e("div",{c:["common_line","lc_beige"]}),e("p",{c:["detail"],g:{innerText:a.shortDescription}})]),Ca=(a,b,c)=>{const {id:d,attributeId:f,title:m}=a,{id:p,rank:u,maxPieceSkillId:[w],doppelMagiaId:pa,commandType:qa}=b;(r=>{k(g("#att",r),f.toLowerCase());
x(g(".charaName",r),a.name).append(...(m?[e("span",{c:["title","ts_pink"],g:{innerText:m}})]:[]))})(g("#detailCardName",c));(r=>g("#detailCardImage",c).append(e("div",{c:["lm_ob","cardFrame",u,f],d:aa("frame_"+f.toLowerCase()+"_"+u.toLowerCase(),"card/frame")}),e("img",{c:["cardImg","se_tabs"],g:{alt:"",title:"Tap to zoom in"},d:r}),e("img",{c:["zoomImg","se_tabs"],g:{alt:"",title:"Tap to zoom out"},d:r}),e("span",{c:["moviePlayBtn","se_tabs","TE"],g:{title:"Transformation videos are disabled in this version"}})))(y("card_"+
p+"_c","card/image"));(([r,E,J],ra)=>{(h=>{A(g("img",h),y("mini_"+b.miniCharaNo+"_s","mini/image"));k(g("#rare",h),u).append(...Array(ra).fill("span").map(q=>e(q)))})(g("#cardDetailMiniChara",r));(h=>{v(".currentLv,.maxLv",q=>x(q,[1,40,50,60,80,100][+u.split("RANK_")[1]]||1),g("#detailLv",h));x(g(".type>.tdStyle",h),{BALANCE:"Balanced",ATTACK:"Attack",DEFENSE:"Defense",MAGIA:"Magia",HEAL:"Heal",SUPPORT:"Support",ULTIMATE:"Ultimate",CIRCLE_MAGIA:"Cycle Magia"}[b.initialType])})(g(".statusWrap",r));
v("#popupCharaStatus .c_red",(h,q)=>x(h,+b[["hp","attack","defense"][q]]*(1+(l.keep_statbug?3:[0,2,2.2,2.4,2.6,3][+u.split("RANK_")[1]]||1)*{BALANCE:[1,1,1],ATTACK:[.98,1.03,.97],DEFENSE:[.97,.98,1.05],HP:[1.04,.97,.98],ATKDEF:[.99,1.02,1.01],ATKHP:[1.02,1.01,.99],DEFHP:[1.01,.99,1.02]}[b.growthType][q])|0),r);[[".profileWrap>.detail",a.description],[".exProfile1>.tdStyle",a.school],[".selCharacterDesign",a.designer],[".selIllustTitle","\u2605"+ra+" Illustrator"],[".selIllustrator",b.illustrator],
[".selCharacterVoice",a.voiceActor]].forEach(([h,q])=>x(g(h,r),q));[["skill",".connect"],["magia",".magiaDetail"]].map(([h,q])=>{q=g(q,E);const {groupId:D,name:K,shortDescription:L}=I(h,b[h+"Id"]);A(g("img",q),y("icon_skill_"+D,"art"));x(g(".name",q),K);x(g(".detail",q),L)});g(".commandList",E).append(...qa.map(h=>e("li",{c:[l.all_discs||h]})));if(w){const h=I("pieceskill",w);g(".command",E).after(e("div",{c:["commonFrame3","connect"]},[e("p",{c:["common_title_frame"],g:{innerText:"EX Skill"}}),e("div",
{c:[l.keep_exbug?"flexbox":"flexBox"]},[e("p",{c:["img"]},[e("img",{d:y("icon_skill_"+h.groupId,"art")})]),oa(h)])]))}pa&&g(".magia",E).append(e("div",{c:["doppel","doppelDetail"]},[e("div",{c:["flexBox"]},[e("p",{c:["img","doppel"]},[e("img",{d:y("mini_"+b.doppelCharaNo+"_dd","mini/image")}),e("span",{c:["bg"]})]),oa(I("magia",pa))])]));g(".discPreview",J).append(...qa.map(h=>e("div",{c:["discWrap",h]},[e("div",{c:["discText"]}),e("img",{d:y("card_"+p+"_d","card/image")})])));G.get(d).forEach((h,
q)=>{var D=h.id;const K="\u2605"+ +h.rank.split("RANK_")[1],L=["mb_pink","se_decide"];D===p&&L.push("selected");D=ma(d,D);g(".miniCharaBtn",J).append(x(e("p",D?{c:L,g:{tabIndex:"4"},d:{commandtype:"card",cardarrindex:q}}:{c:["mb_pink","off"]}),K));g(".selIllustIcon",J).append(e("div",{c:["cardIllustWrap"]},[e("div",D?{c:["userCharaIcon",h.attributeId],a:na(h)}:{c:["offIcon"]}),e("p",D?{c:L,g:{innerText:K,tabIndex:"5"},d:{cardarrindex:q}}:{c:["mb_pink","off"],g:{innerText:K}})]))})})(["Status","Skill",
"Illust"].map(r=>g("#chara"+r,c)),+u.split("RANK_")[1]);[[".collectionBack",()=>history.back()],["#detailCardImage>img",()=>n("detailCardImage").classList.toggle("zoom")],["#detailTab>li",ka],[".moviePlayBtn",()=>setTimeout(r=>t(r),1500,k(n("ready"),"preNativeFadeIn"))],[".cardIllustWrap>.mb_pink",Aa],[".miniCharaBtn>.mb_pink",Ba]].forEach(([r,E])=>v(r,J=>B(J,["pointerup"],E),c));return c},za=async(a,b)=>{var c;if(c=b)c=A(n("cardDetail"),{charaId:a.id}),a=[Ca(a,b,da.cloneNode(!0))],c.replaceChildren(...a);
return c},ka=a=>{const b=a.currentTarget?.dataset.type??a;k(t(n("cardDetailWrap")),b);v("#detailTab>li",c=>(c.dataset.type===b?k:t)(c,"current"))},Aa=({currentTarget:a})=>{if(!X(a,["off","selected"])){t(g(".cardIllustWrap>.selected"),"selected");var {id:b,rank:c,attributeId:d,illustrator:f}=G.get(+n("cardDetail").dataset.charaId)[+k(a,"selected").dataset.cardarrindex];(m=>{v("img",p=>A(p,y("card_"+b+"_c","card/image")),m);A(k(g(".cardFrame",m),"lm_ob"),aa("frame_"+d.toLowerCase()+"_"+c.toLowerCase(),
"card/frame"))})(n("detailCardImage"));x(g(".illustrator"),f);x(g(".selIllustTitle"),"\u2605"+ +c.split("RANK_")[1]+" Illustrator:");R().catch(C)}},Ba=({currentTarget:a})=>{if(!X(a,["off","selected"])){t(g(".miniCharaBtn>.selected"),"selected");a=k(a,"selected").dataset;var b=G.get(+n("cardDetail").dataset.charaId)[+(a.cardarrindex||0)],c=y(...("chara"===a.commandtype?["mini_"+b.miniCharaNo+"_d","mini/image"]:["card_"+b.id+"_d","card/image"]));v(".discPreview>.discWrap>img",d=>A(d,c));R().catch(C)}},
Da=({currentTarget:a})=>{t(g(".tabBtns>.current"),"current");k(t(n("charaWrap")),k(a,"current").dataset.att.toLowerCase(),"commonFrame2")},Ea=({target:a})=>t(a,"touch"),Fa=a=>void setTimeout(b=>b.remove(),700,(b=>document.body.appendChild(e("div",{c:["commonEffect"],i:{top:b.y-128+"px",left:b.x-128+"px"}},Array.from({length:3},(c,d)=>e("div",{c:["effect0"+(d+1)]})))))(a)),Ga=()=>{window.matchMedia("(display-mode:browser)").matches||window.resizeTo(1024+(window.outerWidth-window.innerWidth),Math.min(window.outerHeight,
768+(window.outerHeight-window.innerHeight)));l.mirror&&k(z,"lm_rorrim");l.limit_height&&k(z,"lm_limit_height");l.fix_titlebug&&Z({raw:["{margin-left:8px;}",'::before{content:"[";}','::after{content:"]";}'].map(a=>"#detailCardName>.charaName>.title"+a)});l.no_file&&document.body.append(e("a",{g:{id:"lm_use_setup",href:new URL("setup",location.origin)}}));l.text_case&&k(z,"lm_to"+l.text_case);l.show_kana&&k(z,"lm_kana");l.font?Y("font/"+l.font).then(Z).catch(C):Z({href:new URL("css?family=Open+Sans:600",
"https://fonts.googleapis.com")})};return B(document,["DOMContentLoaded"],()=>{Q(!0);[[["resize"],()=>T=T?clearTimeout(T):setTimeout(ia,500)],[["popstate"],va],[["error"],W]].forEach(c=>B(window,...c));navigator.serviceWorker.register(new URL("doppel.mjs",location.origin),{type:"module"}).catch(C);ia();[[["pointerdown"],".TE",({target:c})=>X(c,["off","current","selected"])||k(c,"touch")],[["pointerup","pointermove"],".TE",Ea],[["pointerdown"],"body",Fa],[["keydown"],"[tabIndex]",c=>void("Enter"===
c.key&&c.target.dispatchEvent(new PointerEvent("pointerup")))],[["contextmenu"],!1,c=>(c.preventDefault(),navigator.vibrate([155,167,146,62,325]),setTimeout(()=>location.assign(new URL("setup",location.origin)),900)),!1]].forEach(([c,d,f,m=!0])=>B(document,c,f,d,{passive:m}));history.replaceState({page:"mgirls"},"Magical Girls Gallery");const a=ua(...["gallery","adjustments"].map(c=>document.cookie.match(new RegExp("(?:^|;)\\s*"+c+"\\s*=\\s*([^;]*)"))?.pop()||null));Ga();const b=P(n("charaWrapInner"),
{display:"none"});Promise.all("art card_d card_f frame mini_d mini_dd mini_s mirrors".split(" ").map(Y)).then(c=>Promise.all([ta(c.pop().data),...c.map(fa)])).then(()=>{Object.entries(a.data).forEach(([c,d])=>M.set(+c,new Set(d.map(Number))));(c=>{da=c.content;c.remove()})(n("tmplCharaDetail"));return Promise.all(F.chara.map(ya))}).then(R).then(()=>{P(b,{display:"block"});v("#tabArea>.tabBtns>li",c=>B(c,["pointerup"],Da));Q(!1);navigator.serviceWorker?.controller?.postMessage({action:"saveMeguca",meguca:[...M.keys()]})}).catch(C)},!1,{once:!0})})
("todestrieb", "LiviaMedeiros");