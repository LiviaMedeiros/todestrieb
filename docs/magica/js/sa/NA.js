/*! todestrieb: Magical Girls Gallery Â© 2021 LiviaMedeiros */
'use strict';((V,M)=>{var y=null,N={},k={fix_scrollbug:!1,fix_titlebug:!1,keep_statbug:!1,keep_exbug:!1,limit_height:!1,hide_missing:!1,show_kana:!1,text_case:!1,font:"koruri",no_file:!1,all_discs:!1,mirror:!1},W=null,O=null;const z=new Map,P=new Map,E=new Map,F=new Map,X=["lm_click","lm_touch"],Q=(a,b=189)=>{a=a.replace(/[^A-Za-z0-9\+\/]/g,"");for(var c=a.length,e=Math.ceil(3*c+1>>2),g=new Uint8Array(e),h,m=0,n=0,q=0;q<c;q++){h=q&3;let p=a.charCodeAt(q);m|=(64<p&&91>p?p-65:96<p&&123>p?p-71:47<p&&
58>p?p+4:43===p?62:47===p?63:0)<<6*(3-h);if(3===h||1===c-q){for(h=0;3>h&&n<e;h++,n++)g[n]=m>>>(16>>>h&24)&255^b;m=0}}return g},u=(a,b)=>{a.innerText=b;return a},r=(a,...b)=>{a.classList.add(...b);return a},x=(a,...b)=>{a.classList.remove(...b);return a},v=document.getElementById.bind(document),G=document.querySelector.bind(document),la=(a,b,c=document)=>c.querySelectorAll(a).forEach(b),d=(a="div",b={},c=[])=>{const {d:e={},c:g=[],g:h={},a:m=[]}=b;(a=Object.assign(document.createElement(a),h)).append(...m,
...c);Object.assign(a.dataset,e);return r(a,...g)},R=a=>fetch(new URL("magica/json/"+a+".json",location.origin),{cache:"force-cache"}).then(b=>location.hostname.toLowerCase().startsWith(V)&&b.json()),Y=a=>Object.entries(a).forEach(([b,c])=>F.set(b,new URL(URL.createObjectURL(new Blob([Q(c,0)],{type:"image/png"}))))),ma=(a,b=!1)=>{a||(k.no_file=!0,a='{"data":{}}');try{N=Object.freeze(JSON.parse(a))}catch(c){return S(c)}if(b)try{b=JSON.parse(b)}catch{}Object.assign(k,("object"===typeof b?b:{})||{},
N.adjustments||{});return N},H=a=>document.documentElement.classList.toggle("connecting",a),na=a=>{a=(new TextDecoder).decode(Q(a));try{y=Object.freeze(JSON.parse(a))}catch(b){S(b)}y.chara.forEach(({id:b})=>z.set(b,y.card.filter(c=>c.charaNo===b)))},T=(a,b=[],c=2,e=100)=>{a.font&&b.push("@font-face{font-family:'Open Sans';src:url("+URL.createObjectURL(new Blob([Q(a.font)],{type:"font/ttf"}))+");}");a.raw&&b.push(...a.raw);a.href&&document.head.append(d("link",{g:{rel:"stylesheet",type:"text/css",
href:a.href}}));(new Promise(g=>{const h=setInterval(()=>{var m=document.styleSheets[c];return m&&(clearInterval(h),g(m))},e)})).then(g=>b.forEach(h=>g.insertRule(h,g.cssRules.length)))},Z=(a=document.documentElement.classList)=>{a.remove(...X);a.add([X[+/ios|android/i.test(navigator.userAgent)]])},oa=a=>(a=a.originalEvent?.state)&&a.chara&&a.card?aa(a):(x(v("mainContent"),"hide"),r(v("cardDetail"),"hide"),ba("status")),A=a=>{r(document.documentElement,"lm_warn");Object.assign(v("loading")??{},{title:"An error occured. You can try to reload the page.",
onpointerup:()=>location.reload()});return console.warn(a),!1},S=a=>{r(document.documentElement,"lm_error");$("#loading").attr({title:"An error occured. You can report about it."}).find("p").on("pointerup",()=>location.assign(new URL(M+"/"+V+"/issues","https://github.com")));return console.error(a.originalEvent),!1},ca=a=>{a.forEach((b,c)=>E.set(c,b));E.forEach((b,c)=>(b=F.get(b))?($("img[data-nativeimgkey="+c+"]").removeAttr("data-nativeimgkey data-src").attr({src:b}),$(".lm_ob[data-nativebgkey="+
c+"]").removeClass(["lm_ob"]).removeAttr("data-nativebgkey data-src").css({backgroundImage:"url("+b+")"})):A(c))},I=(a=new Map)=>{$("img").filter("[data-nativeimgkey]").each((b,{dataset:c})=>(b=c.nativeimgkey)&&!E.has(b)?a.set(b,c.src):!0);$(".lm_ob").filter("[data-nativebgkey]").each((b,{dataset:c})=>(b=c.nativebgkey)&&!E.has(b)?a.set(b,c.src):!0);if([...a.values()].every(F.has.bind(F)))return ca(a);H(!0);Promise.all([...(new Set([...a.keys()].filter(b=>/^card_\d{5}_c$/.test(b))))].map(b=>R("card_c_"+
b.substr(5,4)))).then(b=>{b.forEach(Y);ca(a);H(!1)}).catch(A)},da=(a,b)=>k.card_probability?Math.random()<k.card_probability:P.get(a)?.has(b),pa=({attributeId:a,name:b,id:c,title:e,kana:g})=>d("div",{c:["lm_missing","chara","commonFrame4","se_decide",a],g:{title:b},d:{charaId:c,maxCardRank:0}},[d("div",{c:["nameWrap"]},[d("span",{c:["att",a]}),d("p",{c:["name"],g:{textContent:b}},[d("span",{c:["title"],g:{textContent:e}})]),d("p",{c:["kana"],g:{textContent:g}})]),d("div",{c:["charaIconWrap"]})]),
B=(a,b,c="id")=>y[a].find(({[c]:e})=>e===b),ea=(a,b)=>({alt:"","data-nativeimgkey":a,"data-src":"resource/image_native/"+b+"/"+a+".png"}),w=(a,b)=>({nativeimgkey:a,src:"resource/image_native/"+b+"/"+a+".png"}),fa=(a,b)=>({["nat"+M.substr(1,2)+"ebgkey"]:a,src:"resource/image_native/"+b+"/"+a+".png"}),ra=a=>{const b=a.id,c=k.chara_probability?Math.random()<k.chara_probability:P.get(b)?.size;if(k.hide_missing&&!c)return!1;const e=pa(a);z.get(b).forEach(g=>{const {id:h,rank:m}=g,n=d("div",{c:["userCharaIcon",
g.attributeId,m]});if(da(g.charaNo,h)){const q=+m.split("RANK_")[1];q>+Object.assign(e,{tabIndex:"2"}).dataset.maxCardRank&&Object.assign(x(e,"lm_missing").dataset,{maxCardId:h,maxCardRank:q});n.append(...ha(g))}else n.append(d("span",{c:["closed"]}));e.querySelector(".charaIconWrap").append(n)});c&&e.addEventListener("pointerup",qa);v("charaWrapInner").append(e)},ha=a=>[["att","att","attributeId"],["star","star","rank"],["rank","frame","rank"],[!1,"card","id","_f"],["bg","bg","attributeId"]].map(([b,
c,e,g=""])=>(e=c+"_"+String(a[e]).toLowerCase()+g,b?d("span",{c:["lm_ob",b],d:fa(e,"card/frame")}):d("img",{g:{alt:""},d:w(e,"card/image")}))),qa=a=>{if(!a.cancelable&&a.isTrusted&&k.fix_scrollbug)return!0;a.preventDefault();const {charaId:b,maxCardId:c}=a.currentTarget.dataset;a={page:"mgirl",chara:+b,card:+c};history.pushState(a,"Magical Girl \u2116"+b);return aa(a)},aa=({chara:a,card:b})=>{if(!sa(B("chara",a),B("card",b)))return!1;I();r(v("mainContent"),"hide");x(v("cardDetail"),"hide")},ia=a=>
d("div",{c:["detailWrap"]},[d("p",{c:["name","c_purple"],g:{innerText:a.name}}),d("div",{c:["common_line","lc_beige"]}),d("p",{c:["detail"],g:{innerText:a.shortDescription}})]),sa=(a,b)=>{if(!b)return!1;const c=W.clone()[0],{id:e,attributeId:g,title:h}=a,{id:m,rank:n,maxPieceSkillId:[q],doppelMagiaId:p,commandType:ja}=b;(f=>{r(f.querySelector("#att"),g.toLowerCase());u(f.querySelector(".charaName"),a.name).append(...(h?[d("span",{c:["title","ts_pink"],g:{innerText:h}})]:[]))})(c.querySelector("#detailCardName"));
var C=w("card_"+m+"_c","card/image");c.querySelector("#detailCardImage").append(d("div",{c:["lm_ob","cardFrame",n,g],d:fa("frame_"+g.toLowerCase()+"_"+n.toLowerCase(),"card/frame")}),d("img",{c:["cardImg","se_tabs"],g:{title:"Tap to zoom in"},d:C}),d("img",{c:["zoomImg","se_tabs"],g:{title:"Tap to zoom out"},d:C}),d("span",{c:["moviePlayBtn","se_tabs","TE"],g:{title:"Transformation videos are disabled in this version"}}));const ka=+n.split("RANK_")[1],[J,K,U]=["Status","Skill","Illust"].map(f=>c.querySelector("#chara"+
f));(f=>{Object.assign(f.querySelector("img").dataset,w("mini_"+b.miniCharaNo+"_s","mini/image"));r(f.querySelector("#rare"),n).append(...Array(ka).fill("span").map(l=>d(l)))})(J.querySelector("#cardDetailMiniChara"));(f=>{la(".currentLv,.maxLv",l=>u(l,[1,40,50,60,80,100][+n.split("RANK_")[1]]||1),f.querySelector("#detailLv"));u(f.querySelector(".type>.tdStyle"),{BALANCE:"Balanced",ATTACK:"Attack",DEFENSE:"Defense",MAGIA:"Magia",HEAL:"Heal",SUPPORT:"Support",ULTIMATE:"Ultimate",CIRCLE_MAGIA:"Cycle Magia"}[b.initialType])})(J.querySelector(".statusWrap"));
(f=>({BALANCE:[1,1,1],ATTACK:[.98,1.03,.97],DEFENSE:[.97,.98,1.05],HP:[1.04,.97,.98],ATKDEF:[.99,1.02,1.01],ATKHP:[1.02,1.01,.99],DEFHP:[1.01,.99,1.02]})[b.growthType].map((l,t)=>f.eq(t).text(+b[["hp","attack","defense"][t]]*(1+(k.keep_statbug?3:[0,2,2.2,2.4,2.6,3][+n.split("RANK_")[1]]||1)*l)|0)))($("#popupCharaStatus .c_red",J));[[".profileWrap>.detail",a.description],[".exProfile1>.tdStyle",a.school],[".selCharacterDesign",a.designer],[".selIllustTitle","\u2605"+ka+" Illustrator"],[".selIllustrator",
b.illustrator],[".selCharacterVoice",a.voiceActor]].forEach(([f,l])=>u(J.querySelector(f),l));[["skill",".connect"],["magia",".magiaDetail"]].map(([f,l])=>{l=K.querySelector(l);const {groupId:t,name:L,shortDescription:D}=B(f,b[f+"Id"]);Object.assign(l.querySelector("img").dataset,w("icon_skill_"+t,"art"));u(l.querySelector(".name"),L);u(l.querySelector(".detail"),D)});K.querySelector(".commandList").append(...ja.map(f=>d("li",{c:[k.all_discs||f]})));U.querySelector(".discPreview").append(...ja.map(f=>
d("div",{c:["discWrap",f]},[d("div",{c:["discText"]}),d("img",{d:w("card_"+m+"_d","card/image")})])));q&&(C=B("pieceskill",q),K.querySelector(".command").after(d("div",{c:["commonFrame3","connect"]},[d("p",{c:["common_title_frame"],g:{innerText:"EX Skill"}}),d("div",{c:[k.keep_exbug?"flexbox":"flexBox"]}[d("p",{c:["img"]},[d("img",{d:w("icon_skill_"+C.groupId,"art")})]),ia(C)])])));p&&K.querySelector(".magia").append(d("div",{c:["doppel","doppelDetail"]},[d("div",{c:["flexBox"]},[d("p",{c:["img",
"doppel"]},[d("img",{d:w("mini_"+b.doppelCharaNo+"_dd","mini/image")}),d("span",{c:["bg"]})]),ia(B("magia",p))])]));z.get(e).forEach((f,l)=>{var t=f.id;const L="mb_pink se_decide"+(t===m?" selected":""),D="\u2605"+ +f.rank.split("RANK_")[1];t=da(e,t);$(".miniCharaBtn",U).append($("<p>",t?{"class":L,tabindex:"4",data:{commandtype:"card",cardarrindex:l}}:{"class":"mb_pink off"}).text(D));$(".selIllustIcon",U).append($("<div>",{"class":"cardIllustWrap"}).append($("<div>",t?{"class":"userCharaIcon "+
f.attributeId,append:ha(f)}:{"class":"offIcon"}),$("<p>",t?{"class":L,text:D,tabindex:"5",data:{cardarrindex:l}}:{"class":"mb_pink off",text:D})))});$("#cardDetail").data({charaId:e}).off().on("pointerup",".collectionBack",()=>history.back()).on("pointerup","#detailCardImage>img",()=>v("detailCardImage").classList.toggle("zoom")).on("pointerup","#detailTab>li",ba).on("pointerup",".moviePlayBtn",()=>setTimeout(f=>f.removeClass(),1500,$("#ready").addClass(["preNativeFadeIn"]))).on("pointerup",".cardIllustWrap>.mb_pink",
ta).on("pointerup",".miniCharaBtn>.mb_pink",ua).empty().append(c);return!0},ba=a=>{a=a.currentTarget?$(a.currentTarget).attr("data-type"):a;$("#cardDetailWrap").removeClass().addClass([a]);$("#detailTab>li").removeClass(["current"]).filter("[data-type="+a+"]").addClass(["current"])},ta=a=>{a.preventDefault();x(G(".cardIllustWrap>.selected"),"selected");const {id:b,rank:c,attributeId:e,illustrator:g}=z.get($("#cardDetail").data("charaId"))[$(a.currentTarget).addClass(["selected"]).data("cardarrindex")];
a=$("#detailCardImage");$("img",a).attr(ea("card_"+b+"_c","card/image"));a=$(".cardFrame",a).addClass(["lm_ob"]);var h="frame_"+e.toLowerCase()+"_"+c.toLowerCase();a.attr.call(a,{["data-nat"+M.substr(1,2)+"ebgkey"]:h,"data-src":"resource/image_native/card/frame/"+h+".png"});u(G(".illustrator"),g);u(G(".selIllustTitle"),"\u2605"+ +c.split("RANK_")[1]+" Illustrator:");I()},ua=a=>{a.preventDefault();a=$(a.currentTarget);if(!a.is(".off,.selected")){x(G(".miniCharaBtn>.selected"),"selected");a=a.addClass(["selected"]).data();
var b=z.get($("#cardDetail").data("charaId"))[a.cardarrindex||0];$(".discPreview>.discWrap>img").attr(ea(...("chara"===a.commandtype?["mini_"+b.miniCharaNo+"_d","mini/image"]:["card_"+b.id+"_d","card/image"])));I()}},va=a=>{a.preventDefault();$(".tabBtns>.current").removeClass(["current"]);$("#charaWrap").removeClass().addClass([$(a.currentTarget).addClass(["current"]).data("att").toLowerCase(),"commonFrame2"])};$(document).on("pointerdown",".TE",({currentTarget:a})=>$(a).not(".off,.current,.selected").addClass(["touch"])).on("pointermove pointerup",
".TE",({currentTarget:a})=>x(a,"touch")).on("pointerdown","body",a=>setTimeout(b=>b.remove(),700,(b=>$("<div>",{"class":"commonEffect",css:{top:b.clientY-128+"px",left:b.clientX-128+"px"},append:Array.from({length:3},(c,e)=>d("div",{c:["effect0"+(e+1)]}))}).appendTo("body"))(a))).on("keydown","[tabindex]",a=>("Enter"===a.key&&$(a.currentTarget).trigger("pointerup"),!0)).on("contextmenu",a=>(a.preventDefault(),document.documentElement.requestFullscreen().catch(A))).one("DOMContentLoaded",()=>{H(!0);
Z();$(window).on({resize:()=>O=O?clearTimeout(O):setTimeout(Z,500),popstate:oa,"error unhandledrejection":S});history.replaceState({page:"mgirls"},"Magical Girls Gallery");const a=ma(...["gallery","adjustments"].map(b=>document.cookie.match(new RegExp("(?:^|;)\\s*"+b+"\\s*=\\s*([^;]*)"))?.pop()||null));k.mirror&&r(document.documentElement,"lm_rorrim");k.limit_height&&r(document.documentElement,"lm_limit_height");k.fix_titlebug&&T({raw:["{margin-left:8px;}",'::before{content:"[";}','::after{content:"]";}'].map(b=>
"#detailCardName>.charaName>.title"+b)});k.no_file&&document.body.append(d("a",{g:{id:"lm_use_setup",href:new URL("setup",location.origin)}}));k.text_case&&r(document.documentElement,"lm_to"+k.text_case);k.show_kana&&r(document.documentElement,"lm_kana");k.font?R("font/"+k.font).then(T).catch(A):T({href:new URL("css?family=Open+Sans:600","https://fonts.googleapis.com")});Promise.all("art card_d card_f frame mini_d mini_dd mini_s mirrors".split(" ").map(R)).then(b=>{na(b.pop().data);b.forEach(Y);Object.entries(a.data).forEach(([c,
e])=>P.set(+c,new Set(e.map(Number))));b=v("charaWrapInner");b.style.display="none";W=$($("#tmplCharaDetail").detach()[0].content);y.chara.forEach(ra);I();H(!1);b.style.display="block";$("#tabArea>.tabBtns>li").on("pointerup",va)}).catch(A)})})
("todestrieb", "LiviaMedeiros");
